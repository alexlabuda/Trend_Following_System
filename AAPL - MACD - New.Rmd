---
title: "Trend Following System - Apple Stock"
description: |
  Calculate slow and fast exponential moving averages for AAPL stock using historical data, visualize results and calculate return and performance metrics. Our strategy purchases the stock as the fast  exponential moving average crosses above the slow moving average. This system does not go short.
author: 
  - name: Alex Labuda
    affiliation: Suny New Paltz School of Business - Analytics Capstone
date: "9/9/2021"
output:
  distill::distill_article:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyquant)
library(ggplot2)
library(tidyverse)
library(plotly)
library(quantmod)
library(dplyr)
library(hrbrthemes)
```

# Download AAPL Stock Data

```{r}
getSymbols.warning4.0=FALSE

getSymbols("AAPL", src='yahoo', )
getSymbols("^GSPC", src='yahoo',)
```

```{r}
# AAPL
df <- data.frame(Date=index(AAPL),coredata(AAPL))
# take the last 3000 observations
df <- tail(df, 4000)
# reset index
rownames(df) = NULL

#SPX
SPX <- data.frame(Date=index(GSPC),coredata(GSPC))

SPX <- tail(SPX, 4000)
# reset index
rownames(SPX) = NULL
```


```{r}
# copy the data
raw_data = df
head(raw_data)
summary(raw_data)
```

```{r}
# rename AAPL columns to simplicity
names(raw_data)[names(raw_data)=="AAPL.Open"] = "Open"
names(raw_data)[names(raw_data)=="AAPL.High"] = "High"
names(raw_data)[names(raw_data)=="AAPL.Low"] = "Low"
names(raw_data)[names(raw_data)=="AAPL.Close"] = "Close"
names(raw_data)[names(raw_data)=="AAPL.Volume"] = "Volume"
names(raw_data)[names(raw_data)=="AAPL.Adjusted"] = "Price"

# rename SPX columns to simplicity
names(SPX)[names(SPX)=="GSPC.Open"] = "Open"
names(SPX)[names(SPX)=="GSPC.High"] = "High"
names(SPX)[names(SPX)=="GSPC.Low"] = "Low"
names(SPX)[names(SPX)=="GSPC.Close"] = "Close"
names(SPX)[names(SPX)=="GSPC.Volume"] = "Volume"
names(SPX)[names(SPX)=="GSPC.Adjusted"] = "Price"
```

```{r}
head(raw_data)
head(SPX)
```

## Calculate Daily Return

**Calculate a simple day-to-day return, from adjusted-close to adjusted-close**

```{r}
# AAPL
raw_data$return = NA
raw_data$log_return = NA

for(t in 2:nrow(raw_data)){
  raw_data$return[t] = (raw_data$Price[t] - raw_data$Price[t-1])/ raw_data$Price[t-1]
  raw_data$log_return[t] = log(raw_data$Price[t]/raw_data$Price[t-1])
}

head(raw_data)


# SPX
SPX$return = NA
SPX$log_return = NA

for(t in 2:nrow(SPX)){
  SPX$return[t] = (SPX$Price[t] - SPX$Price[t-1])/ SPX$Price[t-1]
  SPX$log_return[t] = log(SPX$Price[t]/SPX$Price[t-1])
}

head(SPX)
```

# Indicators and Studies

## Calculate Slow and Fast Moving Averages

**Here we calculate a 60-day moving average (slow) as well as a 30-day moving average (fast) to use as our study**

```{r}
Two_MovAvg_function = function(variable, slow_period = 100, fast_period = 20){
  fast_ma = rep(NA, length(variable))
  slow_ma = rep(NA, length(variable))
  
  # MA's
  for (t in (slow_period+1):length(variable)){
    est_slow = mean(variable[(t-(slow_period+1)):(t-1)])
    est_fast = mean(variable[(t-(fast_period+1)):(t-1)])
    
    fast_ma[t] = est_fast
    slow_ma[t] = est_slow
  }
  
  ma_data = data.frame(fast_ma = fast_ma,
                       slow_ma  = slow_ma)
  return(ma_data)
}
```


## Calculate Exponential MA for MACD

```{r}
EA_Mov_Avg = function(variable, slow_lag = 100, fast_lag = 25){
  fast_ea = variable
  slow_ea = variable
  ema_diff = rep(NA, length(variable))
  
  # EMAs
  for (t in 2:length(variable)){ 
      est_slow = slow_ea[t-1] + (slow_ea[t] - slow_ea[t-1]) / ((slow_lag + 1) / 2)
      est_fast = fast_ea[t-1] + (fast_ea[t] - fast_ea[t-1]) / ((fast_lag + 1) / 2)
      
      ema_diff[t] = est_slow - est_fast
      
    slow_ea[t] = est_slow
    fast_ea[t] = est_fast
  }
  
  ema_data = data.frame(fast_ema = fast_ea,
                        slow_ema = slow_ea,
                        ema_diff = ema_diff)
  return(ema_data)
}
```


```{r}
# save these as new columns back to original data 

new_df = EA_Mov_Avg(raw_data$Close, slow_lag = 150, fast_lag = 30)

raw_data$slow_ma = new_df$slow_ema
raw_data$fast_ma = new_df$fast_ema
raw_data$ema_diff = new_df$ema_diff
```


## Average True Range 

### True Range
```{r}
max_range_functon = function(variable){
  max_range = rep(0, length(variable))
  
  for (t in 2:length(raw_data$Price)){
    max_rng = max(abs(raw_data$High[t] - raw_data$Low[t]), abs(raw_data$High[t] - raw_data$Close[t-1]), abs(raw_data$Close[t-1] - raw_data$Low[t]))
    
    max_range[t] = max_rng
  }
  max_range_data = data.frame(max_range = max_range)
  
  return(max_range_data)
}

# Test Function
# max_range_functon(raw_data$Close[1:10])

# Implement on full dataset
max_range_df = max_range_functon(raw_data$Close)

# Create new variable in data
raw_data$max_range = max_range_df$max_range
head(raw_data)
```


### Average True Range Function
```{r}
ATR_function = function(variable, lag = 15){
  atr_list = rep(NA, length(variable))
  
  # MA's
  for (t in (lag+2):length(variable)){
    est_atr = mean(variable[(t-(lag)):t])
    
    atr_list[t] = est_atr
  }
  
  atr_data = data.frame(atr = atr_list)
  return(atr_data)
}

atr_data = ATR_function(raw_data$max_range)
raw_data$atr = atr_data$atr
```

### Risk per lot

```{r}
risk_multiplier = 5
equity = 100000


raw_data$risk_per_lot = raw_data$atr * risk_multiplier
head(raw_data) 
```


```{r}
# store cross over dates for charting annotations

h = raw_data[which((raw_data$fast_ma > raw_data$slow_ma) & (raw_data$fast_ma[-1] < raw_data$slow_ma[-1]))+1,]
l = raw_data[which((raw_data$fast_ma < raw_data$slow_ma) & (raw_data$fast_ma[-1] > raw_data$slow_ma[-1]))+1,]
h = na.exclude(h)
h
l
```


```{r}
# Create arrow annotations

# Upper annotations
h_a <- list(
  x = h$Date,
  y = h$slow_ma,
  text = "Sell",
  xref = "x",
  yref = "y",
  showarrow = TRUE,
  arrowcolor = "red",
  arrowhead = 5,
  arrowsize = 0.8,
  arrowwidth = 1.5,
  opacity = 0.75,
  align = "left",
  ax = 5,
  ay = -55
)

# Lower annotations

l_a <- list(
  x = l$Date,
  y = l$slow_ma,
  text = "Buy",
  xref = "x",
  yref = "y",
  showarrow = TRUE,
  arrowcolor = "green",
  arrowhead = 5,
  arrowsize = 0.8,
  arrowwidth = 1.5,
  opacity = 0.75,
  align = "right",
  ax = -5,
  ay = 55
)


# figure labels
f <- list(
  family = "Courier New, monospace",
  size = 18,
  color = "#7f7f7f ")
x <- list(
  title = "x Axis",
  titlefont = f)
y <- list(
  title = "y Axis",
  titlefont = f)
``` 

# **Candlestick Chart**

## Visualizing Moving Average Crossover

**A candlestick chart to help visualize what our strategy attempts to do**

```{r}

# colors column for increasing and decreasing
for (i in 2:length(raw_data[,1])) {
  if (raw_data$ema_diff[i] > 0) {
      raw_data$MACD_direction[i] = 'Increasing'
  } else {
      raw_data$MACD_direction[i] = 'Decreasing'
  }
}

# color of bars for chart
i <- list(line = list(color = '#17BECF')) # 'i' for increasing
d <- list(line = list(color = '#b22222')) # 'd' for decreasing


# Plot main data
fig <- raw_data %>% plot_ly(x = ~Date, type="ohlc",
          open = ~Open, close = ~Close,
          high = ~High, low = ~Low, name = "AAPL",
          increasing = i, decreasing = d)

# Add Fast and Slow moving average lines
fig <- fig %>% add_lines(x = ~Date, y = ~slow_ma, name = "Slow",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bands", inherit = F,
            showlegend = TRUE, hoverinfo = "none") 
fig <- fig %>% add_lines(x = ~Date, y = ~fast_ma, name = "Fast",
            line = list(color = '#E377C2', width = 0.5),
            hoverinfo = "none", inherit = F)
# Add y-axis title
fig <- fig %>% layout(yaxis = list(title = "Price"))


# plot MACD line subplot
fig2 <- raw_data 
fig2 <- fig2 %>% plot_ly(x=~Date, y=~ema_diff, type='bar', name = "MACD",
                         color = ~MACD_direction, colors = c("red", "green"), alpha = 0.8)
fig2 <- fig2 %>% layout(yaxis = list(title = "MACD"))


fig = subplot(fig, fig2, heights = c(0.8,0.15), nrows = 2,
              shareX = TRUE, titleY = TRUE)

# Add arrow annotations
fig <- fig %>% layout(annotations = h_a)
fig <- fig %>% layout(annotations = l_a)

# Add title
fig <- fig %>% layout(title = "AAPL Stock - Moving Average Crossover",
                       xaxis = list(rangeslider = list(visible = F)))

fig
```

# Generate signals using MA Indicator

**Now we use our indicator to generate a signal**


```{r}
raw_data$signal = NA

# Loop through data to create signal column
for(t in 100:nrow(raw_data)){
  
  current_slow = raw_data$slow_ma[t]
  current_fast = raw_data$fast_ma[t]
  
  prev_slow = raw_data$slow_ma[t-1]
  prev_fast = raw_data$fast_ma[t-1]
  
  # use 'if' statement to translate crossover into signals
  if(current_fast > current_slow & prev_fast < prev_slow) {signal = "B"} else 
    if(current_fast < current_slow & prev_fast > prev_slow) {signal = "S"} else
      {signal = "H"}
  
  raw_data$signal[t] = signal
}
```

## Holding Status and Investment Return

**After generating a signal, we must calculate the return from our strategy**

In order to calculate switching from short to long simultaneously, we need to calculate
two returns and combine them:
Say we go buy -> short
- $1+r1$ * $1+r2$ = $(1+avg(r1,r2))$

```{r}
# used to calculate fill price skid

buy_weight = .40
sell_weight = -.40
```


```{r}
# Generate a holding status column # 
# and investment return column

raw_data$holding = 0      # first record, you are not holding
raw_data$Inv_return = NA  # obviously the return will also be 0

# we can begin the loop
for (t in 100:nrow(raw_data)){
  
  if(t==1){prev_holding=0} 
  else {prev_holding=raw_data$holding[t-1]}
  
  # look at the signal to decide the change of holding status
  signal = raw_data$signal[t]
  if(signal=="B"){raw_data$holding[t]=1} else 
    if (signal=="S") {raw_data$holding[t]=0} else 
      if (signal=="H"){raw_data$holding[t]=prev_holding}
  
  # Now calculate investment return
  Open = raw_data$Open[t]
  Close = raw_data$Close[t]
  High = raw_data$High[t]
  Low = raw_data$Low[t]
  
  if(prev_holding==0 & signal=="B"){investment_return=Close/((High-Open)*buy_weight+Open) - 1} else 
    if(prev_holding==0 & signal=="H"){investment_return=0} else 
      #if(prev_holding==1 & signal=="S"){investment_return=Close[t-1]/(Open*(1+sell_weight)) - 1} else
      #if(prev_holding==0 & signal=="S"){investment_return=(-1)*(Close/(Open*(1+sell_weight)) - 1)} else
        if(prev_holding==1 & signal=="B"){investment_return=Close/raw_data$Close[t-1]-1} else
          if(prev_holding==1 & signal=="H"){investment_return=Close/raw_data$Close[t-1]-1} else
            {investment_return = Open/raw_data$Close[t-1]-1}
 
   # save the investment return to the dataset
  raw_data$Inv_return[t] = investment_return}
```


## Cumulative Return


```{r}
initial_wealth = 100000
raw_data$cash = rep(initial_wealth, length(raw_data$Close))
raw_data$n_stock = rep(0, length(raw_data$Close))

for (t in 1:length(raw_data$signal)){
  
  if(t==1){prev_cash = initial_wealth; n_stock = 0
    
    } else
      
      {prev_cash = raw_data$cash[t-1]; 
      n_stock = raw_data$n_stock[t-1]}
  
  signal = raw_data$signal[t]
  Open = raw_data$Open[t]
  Close = raw_data$Close[t]
  High = raw_data$High[t]
  Low = raw_data$Low[t]
  
  #### Note: Added is.na to skip rows at the beginning of the data that do not have a signal
  
  if(is.na(signal)==TRUE){
    prev_cash = raw_data$cash[t-1]
    n_stock = raw_data$n_stock[t-1] 
    
    } else
      
      if (signal=="B"){
        buy_skid = (High-Open) * buy_weight + Open
        trans_prc = buy_skid
        n_change = floor(prev_cash/trans_prc)
        stock_n = n_stock + n_change
        cash = prev_cash - n_change * trans_prc
            
        raw_data$cash[t] = cash
        raw_data$n_stock[t] = stock_n
        
        } else
          
          #### I believe the trouble is with the follow if statement
          ### It seems that the Buy signal works but I am having trouble implementing the sell update
          ## Note: I changed my system so that it does not go short; it can go long only
          
          if (signal =="S"){
            sell_skid = (Open-Low) * sell_weight + Open
            trans_prc = sell_skid
            n_change = n_stock
            stock_n = n_change - n_stock
            cash = prev_cash + n_change * trans_prc
        
            raw_data$cash[t] = cash
            raw_data$n_stock[t] = stock_n
            
            }else
              
              if (signal == "H") {
                raw_data$cash[t] = raw_data$cash[t-1]
                raw_data$n_stock[t] = raw_data$n_stock[t-1]
                
                }
}
```

## **Final Return**
```{r}
print(raw_data[max(index(raw_data)),])

final_return = raw_data$n_stock[max(index(raw_data))] * raw_data$Close[max(index(raw_data))] + raw_data$cash[max(index(raw_data))-1]

print(paste("Initial Investment:", sprintf("$ %3.2f", initial_wealth)))
print(paste("Final Return:",sprintf("$ %3.2f" , final_return)))

```


## Max Adverse & Favorable Excursion

**Let's look at the days with the largest gains and losses**

```{r}
max_daily_return = round((max(raw_data$Inv_return, na.rm = TRUE)*100),4)
max_daily_loss =  round((min(raw_data$Inv_return, na.rm = TRUE)*100), 4)
avg_daily_return = round((mean(raw_data$Inv_return, na.rm = TRUE)*100),4)

bh_max_return = round((max(raw_data$return, na.rm = TRUE)*100),4)
bh_max_loss =  round((min(raw_data$return, na.rm = TRUE)*100), 4)
bh_avg_return = round((mean(raw_data$return, na.rm = TRUE)*100),4)

print(paste("Largest 1-day return with trend system:", max_daily_return,"%"))
print(paste("Largest 1-day loss with trend system:", max_daily_loss,"%"))
print(paste("Average 1-day with trend system return:", avg_daily_return,"%"))

print(paste("Largest 1-day return buy and hold strategy:", bh_max_return,"%"))
print(paste("Largest 1-day loss with buy and hold strategy:", bh_max_loss,"%"))
print(paste("Average 1-day with buy and hold strategy:", bh_avg_return,"%"))
```


# Performance Evaluation

## Distribution of Returns

```{r}
p <- raw_data %>%
  ggplot(aes(x=Inv_return)) +
    geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.7, binwidth = .005) +
  coord_cartesian(xlim = c(-0.07, 0.07), ylim = c(0, 500)) +
  labs(x = "Investment Returns", y = "Frequency of Returns",
       title = "EMA Crossover - Histogram of Investment Returns",
       caption = "Trend following system - Slow lag: 100 periods, Fast lag: 20 periods")+
  theme_classic()
p


bh = raw_data %>%
  ggplot(aes(x=return)) +
    geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.7, binwidth = .005) +
  coord_cartesian(xlim = c(-0.07, 0.07), ylim = c(0, 500)) +
  labs(x = "Investment Returns", y = "Frequency of Returns",
       title = "Buy / Hold - Histogram of Investment Returns",
       caption = "This histogram considers a buy and hold strategy")+
  theme_classic()
bh
```


## Mean and Standard Deviation 

**Provide the average daily return and volatility of the trading system**

```{r}
average_return = mean(raw_data$Inv_return, na.rm = TRUE) # average return
volatility = sd(raw_data$Inv_return, na.rm = TRUE) # volatility

print(paste("Average return:", round(average_return,6)))
print(paste("Volatility:", round(volatility,6)))


bh_average_return = mean(raw_data$return, na.rm = TRUE) # average return
bh_volatility = sd(raw_data$return, na.rm = TRUE) # volatility

print(paste("Average return:", round(bh_average_return,6)))
print(paste("Volatility:", round(bh_volatility,6)))
print(paste("Buy and hold strategy witnesses much higher volatility for a small amount of additional return"))
```

## Sharpe Ratio

**Volatility is used to measure the risk**

-   Risk adjusted measure

-   Sharpe ratio is sensitive to the frequency of return

-   You must also specify whether the ratio is based on daily, weekly, or monthly data

-   If implementing the strategy with different parameters, we compare Sharpe ratios

    -   we use it as a relative comparison measure

    -   make sure the calculation is based on the same frequency of returns

```{r}
rf = .00001  

print(paste("Trend following: Sharpe ratio of daily returns:",round((average_return-rf)/volatility,5)))
print(paste("Buy & hold: Sharpe ratio of daily returns:",round((bh_average_return-rf)/bh_volatility,5)))

print(paste("   Trend following system achieves slightly higher Sharpe ratio"))
```



## Value at Risk

**VAR** measures the cut-off return that your financial asset will fall below with certain probability.

-   By default we generally examine 5% VAR (5% of the time, your return will be below this return) using percentiles.

-   This means that about 5% of the time, your investment return is below : -14.76767%

-   In other words, at any given date there is a 5% probability that the daily (because we calculated the daily returns) return will be below -14.76767%

-   Here's how we calculate it:

```{r}
var = quantile(raw_data$Inv_return, 0.05, na.rm = TRUE)*100
bh_var = quantile(raw_data$return, 0.05, na.rm = TRUE)*100

print(paste("Trend-following Value at risk; we can expect 95% of the time returns will be greater than:", round(var,4)))
print(paste("Buy / Hold Value at risk; we can expect 95% of the time returns will be greater than:", round(bh_var,4)))
```


# Summary of Investment Return & Market Return

```{r}
summary(raw_data$Date)
```


## Calculate SPX Daily Return

-   Our $y$ is the excess return of the Stock

-   Our $x$ is the excess return of the market

```{r}
y = raw_data$Inv_return - rf
x = SPX$return - rf
```


```{r}
capm = lm(y~x)
summary(capm)
```

This trading $BETA$ is, the larger the systematic risk is

**Beta** is the slope (x)

$Beta$ > 1 indicates an aggressive stock

Beta between 0 and 1 indicates a conservative stock

We use this to measure the aggressiveness of the stock or the trading system

# Visualize Days with Largest Loss and Gain

```{r}
max_gain=raw_data[which.max(raw_data$Inv_return),]
max_loss = raw_data[which.min(raw_data$Inv_return),]

# max(raw_data$Inv_return, na.rm = TRUE)

# Create subset
max_data = raw_data[3310:3330,]
min_data = raw_data[3310:3330,]
```

```{r}
max_loss
max_gain
```

```{r}
# Create arrow annotations

# Upper annotations
h_a <- list(
  x = max_gain$Date,
  y = max_gain$Price,
  text = "Largest Gain",
  xref = "x",
  yref = "y",
  showarrow = TRUE,
  arrowcolor = "green",
  arrowhead = 5,
  arrowsize = 0.8,
  arrowwidth = 2.5,
  opacity = 0.75,
  align = "right",
  ax = 5,
  ay = -55
)

# Lower annotations

l_a <- list(
  x = max_loss$Date,
  y = max_loss$Price,
  text = "Largest Loss",
  xref = "x",
  yref = "y",
  showarrow = TRUE,
  arrowcolor = "green",
  arrowhead = 5,
  arrowsize = 0.8,
  arrowwidth = 2.5,
  opacity = 0.75,
  align = "right",
  ax = -5,
  ay = 55
)


# figure labels
f <- list(
  family = "Courier New, monospace",
  size = 18,
  color = "#7f7f7f ")
x <- list(
  title = "x Axis",
  titlefont = f)
y <- list(
  title = "y Axis",
  titlefont = f)
```

## Largest Gain

```{r}
fig <- max_data %>% plot_ly(x = ~Date, type="ohlc",
          open = ~Open, close = ~Close,
          high = ~High, low = ~Low, name = "AAPL",
          increasing = i, decreasing = d)

# color of bars for chart
i <- list(line = list(color = '#17BECF')) # 'i' for increasing
d <- list(line = list(color = '#b22222')) # 'd' for decreasing

# Add Fast and Slow moving average lines
fig <- fig %>% add_lines(x = ~Date, y = ~slow_ma, name = "Slow",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bands", inherit = F,
            showlegend = TRUE, hoverinfo = "none") 
fig <- fig %>% add_lines(x = ~Date, y = ~fast_ma, name = "Fast",
            line = list(color = '#E377C2', width = 0.5),
            hoverinfo = "none", inherit = F)

# Add y-axis title
fig <- fig %>% layout(yaxis = list(title = "Price"))

# Add arrow annotations
fig <- fig %>% layout(annotations = h_a)

# Add title
fig <- fig %>% layout(title = "AAPL Stock - Strategy Largest 1-Day Gain",
                       xaxis = list(rangeslider = list(visible = F)))

fig
```

## Largest Loss

```{r}
fig <- min_data %>% plot_ly(x = ~Date, type="ohlc",
          open = ~Open, close = ~Close,
          high = ~High, low = ~Low, name = "AAPL",
          increasing = i, decreasing = d)

# color of bars for chart
i <- list(line = list(color = '#17BECF')) # 'i' for increasing
d <- list(line = list(color = '#b22222')) # 'd' for decreasing

# Add Fast and Slow moving average lines
fig <- fig %>% add_lines(x = ~Date, y = ~slow_ma, name = "Slow",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bands", inherit = F,
            showlegend = TRUE, hoverinfo = "none") 
fig <- fig %>% add_lines(x = ~Date, y = ~fast_ma, name = "Fast",
            line = list(color = '#E377C2', width = 0.5),
            hoverinfo = "none", inherit = F)

# Add y-axis title
fig <- fig %>% layout(yaxis = list(title = "Price"))

# Add arrow annotations
fig <- fig %>% layout(annotations = l_a)

# Add title
fig <- fig %>% layout(title = "AAPL Stock - Strategy Largest 1-day Loss",
                       xaxis = list(rangeslider = list(visible = F)))

fig
```


